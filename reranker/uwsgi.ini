[uwsgi]
chdir = /reranker
module = main:app
master = true

# 프로세스 및 스레드 최적화 - 응답시간 개선을 위해 설정 변경
processes = 24               # 고정된 프로세스 수 설정 (CPU 코어의 절반으로 설정)
threads = 4                  # 스레드 수 증가 (동시 요청 처리 향상)
thunder-lock = true          # 다중 프로세스 잠금 최적화
enable-threads = true        # 스레드 활성화
single-interpreter = true    # 인터프리터 공유로 메모리 사용량 감소
max-worker-lifetime = 600    # 워커 최대 수명 (10분) - 메모리 누수 방지
cheaper-algo = spare         # 동적 워커 관리 
cheaper = 8                  # 최소 워커 수
cheaper-initial = 16         # 초기 워커 수
cheaper-step = 4             # 한 번에 늘릴/줄일 워커 수

# 소켓 설정 - 응답 지연 개선
socket = /tmp/reranker.sock
chmod-socket = 666
vacuum = true
die-on-term = true
protocol = fastcgi
so-keepalive = true          # TCP 연결 유지
so-sndbuf = 65536            # 소켓 전송 버퍼 크기 증가 (64KB)
so-rcvbuf = 65536            # 소켓 수신 버퍼 크기 증가 (64KB)
listen = 1024                # 연결 대기열 크기 증가

# 애플리케이션 설정
lazy-apps = false            # 미리 앱 로드 (첫 응답 시간 개선)
need-app = true              # 애플리케이션 로드 실패 시 종료

# 메모리 최적화
reload-on-rss = 2048         # 2GB 이상 메모리 사용 시 자동 재시작
reload-on-as = 3072          # 3GB 이상 주소 공간 사용 시 자동 재시작
reload-mercy = 10            # 재시작 시 10초 대기
worker-reload-mercy = 10     # 워커 재시작 시 10초 대기
max-requests = 10000         # 최대 요청 수 증가
memory-report = true         # 메모리 사용량 보고

# 버퍼 설정 - 버퍼 최적화로 응답 속도 개선
buffer-size = 131072         # 버퍼 크기 2배 증가 (128KB)
post-buffering = 16384       # POST 요청 버퍼링 크기 2배 증가 (16KB)
socket-send-bufsize = 16384  # 소켓 send 버퍼 크기

# 타임아웃 설정
harakiri = 60                # 요청 처리 타임아웃 감소 (좀비 프로세스 예방)
socket-timeout = 30          # 소켓 타임아웃 감소
http-timeout = 30            # HTTP 타임아웃 추가
mule-timeout = 30            # mule 타임아웃 추가

# 로깅 설정 - 디버깅 용이성 향상
log-date = true              # 로그에 날짜 표시
log-slow = 200               # 200ms 이상 걸리는 요청 로깅
log-5xx = true               # 5xx 에러 로깅
log-4xx = true               # 4xx 에러 로깅
disable-logging = false      # 로깅 활성화

# 캐시 최적화 - 캐시 확장으로 반복 요청 속도 향상
cache2 = name=rerankcache,items=1000    # 캐시 항목 10배 증가
cache-store = persistent                # 메모리 캐시 사용
cache-blocksize = 8192                  # 캐시 블록 크기 2배로 증가
cache-no-expire = true                  # 캐시 만료 방지
cache-report = true                     # 캐시 사용량 보고

# 성능 최적화 옵션 추가
offload-threads = 8                     # I/O 작업을 위한 오프로드 스레드
close-on-exec = true                    # fork 후 자원 관리 개선
no-orphans = true                       # 고아 프로세스 방지
optimize = true                         # 일반 최적화 옵션 활성화 