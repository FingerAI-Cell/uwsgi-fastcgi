[uwsgi]
chdir = /reranker
module = main:app
master = true

# 프로세스 및 스레드 최적화
processes = %(%k + 1)        # CPU 코어 수 + 1 (최적의 프로세스 수)
threads = 2                  # 프로세스당 스레드 수
thunder-lock = true          # 다중 프로세스 잠금 최적화
enable-threads = true        # 스레드 활성화

# 소켓 설정
socket = /tmp/reranker.sock
chmod-socket = 666
vacuum = true
die-on-term = true
protocol = fastcgi

# 애플리케이션 설정
lazy-apps = true             # 각 워커 프로세스에서 애플리케이션 로드 (메모리 격리)
need-app = true              # 애플리케이션 로드 실패 시 종료

# 메모리 최적화
reload-on-rss = 2048         # 2GB 이상 메모리 사용 시 자동 재시작
reload-on-as = 3072          # 3GB 이상 주소 공간 사용 시 자동 재시작
reload-mercy = 10            # 재시작 시 10초 대기
worker-reload-mercy = 10     # 워커 재시작 시 10초 대기
max-requests = 10000         # 최대 요청 수 증가
memory-report = true         # 메모리 사용량 보고

# 버퍼 설정
buffer-size = 65535          # 버퍼 크기 유지
post-buffering = 8192        # POST 요청 버퍼링 크기 증가

# 타임아웃 설정
harakiri = 300               # 요청 처리 타임아웃
socket-timeout = 300         # 소켓 타임아웃

# 로깅 설정
log-date = true              # 로그에 날짜 표시
log-slow = 200               # 200ms 이상 걸리는 요청 로깅
log-5xx = true               # 5xx 에러 로깅
log-4xx = true               # 4xx 에러 로깅
disable-logging = false      # 로깅 활성화

# 캐시 최적화
cache2 = name=rerankcache,items=100
cache-blocksize = 4096 